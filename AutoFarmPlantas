local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

local promptRange = math.huge
local isActivating = false
local isRunning = false
local started = false
local isInDanger = false

local startTime = 0
local pausedTime = 0
local pauseStart = 0
local totalPromptsActivated = 0
local lastTeleportTime = 0
local originalPosition = nil
local lastHealth = humanoid.Health
local tweenF = false

-- Função para mover com Tween
local function Tp(pos, onComplete)
	tweenF = true
	local destino = pos
	local VELOCIDADE = 300

	local distancia = (destino - humanoidRootPart.Position).Magnitude
	local duracao = distancia / VELOCIDADE

	local tweenInfo = TweenInfo.new(duracao, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
	local goal = {Position = destino}

	humanoidRootPart.Anchored = true
	local tween = TweenService:Create(humanoidRootPart, tweenInfo, goal)
	tween:Play()

	tween.Completed:Connect(function()
		tweenF = false
		if onComplete then onComplete() end
	end)
end

-- Criação do botão da GUI
local function setupTimerGui()
	if not player.PlayerGui:FindFirstChild("TimeC") then
		local guiT = Instance.new("ScreenGui")
		guiT.Name = "TimeC"
		guiT.ResetOnSpawn = false
		guiT.Parent = player.PlayerGui

		local t = Instance.new("TextButton")
		t.Name = "Tempo"
		t.Text = "Clique Aqui Para Começar"
		t.Size = UDim2.new(1, 0, 0, 25)
		t.Position = UDim2.new(0, 0, 0, 0)
		t.BackgroundTransparency = 1
		t.TextColor3 = Color3.fromRGB(255, 255, 255)
		t.TextStrokeTransparency = 0.5
		t.Font = Enum.Font.SourceSansBold
		t.TextSize = 20
		t.Parent = guiT

		t.MouseButton1Click:Connect(function()
			if not started then
				started = true
				isRunning = true
				startTime = tick()
				t.Text = "Tempo: 00:00:00 | Tps: 0 | Clique Para Pausar"
			else
				toggleSystem()
			end
		end)
	end
end

-- Alternar entre pausa e execução
function toggleSystem()
	if isInDanger then return end
	isRunning = not isRunning
	local button = player.PlayerGui.TimeC.Tempo
	if isRunning then
		pausedTime += tick() - pauseStart
		button.Text = "Retomando..."
	else
		if not tweenF then
			Tp(Vector3.new(11987, 45, 12761))
		end
		pauseStart = tick()
		button.Text = "PAUSADO | Clique Para Continuar"
	end
end

-- Atualização da GUI de tempo
local function updateTimerGui()
	local gui = player.PlayerGui:FindFirstChild("TimeC")
	if gui then
		local label = gui:FindFirstChild("Tempo")
		if label and started then
			if isInDanger then
				label.Text = "EM RISCO! Aguarde 10s..."
			elseif isRunning then
				local elapsed = math.floor(tick() - startTime - pausedTime)
				local h = math.floor(elapsed / 3600)
				local m = math.floor((elapsed % 3600) / 60)
				local s = elapsed % 60
				label.Text = string.format("Tempo: %02d:%02d:%02d | Plantas Sujas: %d | Clique Para Pausar", h, m, s, totalPromptsActivated)
			end
		end
	end
end

-- Procurar o ProximityPrompt mais próximo
local function getNearestPrompt()
	for _, prompt in workspace:GetDescendants() do
		if prompt:IsA("ProximityPrompt") and prompt.Enabled and prompt.ActionText == "Colher" then
			return prompt
		end
	end
	return nil
end

-- Teleporta, ativa prompt, desce para dentro da terra e espera
local function teleportAndActivatePrompt(prompt: ProximityPrompt)
	local part = prompt.Parent:IsA("BasePart") and prompt.Parent or prompt.Parent:FindFirstChildWhichIsA("BasePart")
	if part then
		isActivating = true
		lastTeleportTime = tick()

		Tp(part.Position + Vector3.new(0, 3, 0), function()
			prompt:InputHoldBegin()

			task.delay(prompt.HoldDuration + 0.2, function()
				if not isRunning or isInDanger then
					prompt:InputHoldEnd()
					isActivating = false
					return
				end

				prompt:InputHoldEnd()

				if isActivating and not prompt.Enabled then
					local underGround = humanoidRootPart.Position - Vector3.new(0, 10, 0)

					Tp(underGround, function()
						humanoidRootPart.Anchored = true
						task.wait(15)
						humanoidRootPart.Anchored = false

						totalPromptsActivated += 1
						isActivating = false
					end)
				else
					isActivating = false
				end
			end)
		end)
	end
end

-- Estado de risco
local function enterRiskState()
	if isInDanger and isRunning then return end
	isInDanger = true
	isRunning = false
	originalPosition = humanoidRootPart.CFrame

	local button = player.PlayerGui.TimeC and player.PlayerGui.TimeC:FindFirstChild("Tempo")
	if button then
		button.Text = "EM RISCO! Aguarde 10s..."
	end

	humanoidRootPart.CFrame = humanoidRootPart.CFrame + Vector3.new(0, 150, 0)
	humanoidRootPart.Anchored = true

	task.delay(10, function()
		humanoidRootPart.CFrame = originalPosition
		humanoidRootPart.Anchored = false
		isInDanger = false
		isRunning = true

		if button then
			button.Text = "Tempo Retomado | Clique Para Pausar"
		end
	end)
end

-- Detecta dano
humanoid.HealthChanged:Connect(function(currentHealth)
	if currentHealth < lastHealth then
		enterRiskState()
	end
	lastHealth = currentHealth
end)

-- Inicializa a GUI
setupTimerGui()

-- Atualiza tempo constantemente
task.spawn(function()
	while true do
		updateTimerGui()
		task.wait()
	end
end)

-- Loop principal
RunService.RenderStepped:Connect(function()
	if not started or not isRunning or isActivating or isInDanger then return end
	if tick() - lastTeleportTime < 0.5 then return end

	local prompt = getNearestPrompt()
	if prompt and not humanoidRootPart.Anchored then
		isActivating = true
		prompt.HoldDuration = 0
		teleportAndActivatePrompt(prompt)
	else
		if not tweenF then
			Tp(Vector3.new(11987, 45, 12761))
		end
	end
end)
